const t={direction:"ltr",fillStyle:"black",fillStyle:"#fff",filter:"none",font:"16px "+(["楷体","黑体","宋体","微软雅黑","仿宋","娃娃体-简","兰亭黑-简","凌慧体-简","翩翩体-简","魏碑体-简","雅痞体-简","苹方-简","楷体-简","黑体-简","宋体-简","Roboto","Noto Sans","Droid"].find((function(t,e=16){return document.fonts.check(`${e}px ${t}`)}))||"楷体"),globalAlpha:1,globalCompositeOperation:"source-over",imageSmoothingEnabled:!1,lineCap:"butt",lineDashOffset:0,lineJoin:"miter",lineWidth:1,miterLimit:10,shadowBlur:0,shadowColor:"rgba(0, 0, 0, 0)",shadowOffsetX:0,shadowOffsetY:0,strokeStyle:"white",textAlign:"center",textBaseline:"middle"};class e{clearRect(){const{context:t}=this,{canvas:e}=t;t.clearRect(0,0,e.width,e.height)}drawImage(t,e,i){const{pixelRatio:s}=this.config,{props:n}=t,{sposition:o={},spixelRatio:r={},image:a}=n,{width:h=0,height:c=0}=n.size||{},{context:l}=this,{sx:d=0,sy:g=0}=o,{swidth:f=h,sheight:p=c}=r,u=this.getImage(a);u&&l.drawImage(u,d*s,g*s,f*s,p*s,e*s,i*s,h*s,c*s)}drawBorder(t,e,i){const{pixelRatio:s}=this.config,{context:n}=this,{width:o,color:r}=t.props.border,{width:a=0,height:h=0}=t.props.size||{};o&&(n.save(),n.lineWidth=o,n.beginPath(),n.rect(e*s+o/2,i*s+o/2,a*s-o,h*s-o),n.strokeStyle=r,n.stroke(),n.closePath(),n.restore())}drawBackgroundImage(t,e,i){const{pixelRatio:s}=this.config,{context:n}=this,o=t.props.bgImage,{width:r=0,height:a=0}=t.props.size||{};if(o){n.save(),n.beginPath(),n.rect(e*s,i*s,r*s,a*s);const t=this.getImage(o);t?(n.fillStyle=n.createPattern(t,"repeat"),n.fill(),n.closePath(),n.restore()):this.$loader.loadImage(o)}}drawBackgroundColor(t,e,i){const s=t.props.bgColor;if(s){const{pixelRatio:n}=this.config,{context:o}=this,{width:r=0,height:a=0}=t.props.size||{};o.save(),o.beginPath(),o.fillStyle=s,o.rect(e*n,i*n,r*n,a*n),o.fill(),o.restore(),o.closePath()}}drawText(t,e,i){const{text:s,size:n}=t.props,{context:o}=this,{pixelRatio:r}=this.config,{textAlign:a,textBaseline:h}=o,{width:c=0,height:l=0}=n||{};"center"===a&&(e+=c/2),"middle"===h&&(i+=l/2),o.fillText(s,e*r,i*r)}drawTextPrimitiv(t,e,i,s){const{size:n}=s.props,{context:o}=this,{pixelRatio:r}=this.config,{textAlign:a,textBaseline:h}=o,{width:c=0,height:l=0}=n||{};"center"===a&&(e+=c/2),"middle"===h&&(i+=l/2),o.fillText(t,e*r,i*r)}drawLineGradient(t,e,i){const{lineGradient:s}=t.props,{pixelRatio:n}=this.config;if(s){const{context:t}=this;t.fillStyle=s,t.fillRect(e*n,i*n,2e3,32)}}}const i=t=>Array.isArray(t),s=t=>null==t,n=t=>"Object"===(t=>Object.prototype.toString.call(t).slice(8,-1))(t),o=t=>t&&n(t.createtor),r=t=>t&&"string"==typeof t.createtor,a=t=>(t=>{const e=typeof t;return"string"===e||"number"===e})(t)||s(t)||"boolean"==typeof t;class h extends e{constructor(t,e){super(),this.config=t.screen,this.$loader=e,this.initCanvas(t)}getImage(t){return this.$loader.$resource.image[t]}initCanvas(){const{pixelRatio:e,el:i,width:s=13,height:n=13}=this.config,o=document.createElement("canvas");this.canvas=o,this.context=o.getContext("2d"),this.canvas.width=s*e,this.canvas.height=n*e;const r=document.querySelector(i||"#game")||document.body;r&&r.appendChild(this.canvas),this.mergeStyle(t),this.getCanvasRenderRect()}getCanvasRenderRect(){const t=this.canvas;this.canvas.$offsetWidth=t.offsetWidth,this.canvas.$offsetHeight=t.offsetHeight}mergeStyle(t){Object.assign(this.context,t)}drawNode(t,e,i,s){const{context:n}=this;n.save();const{children:o,props:r}=t;if(r){const{style:n,image:o,text:a,border:h,bgImage:c,bgColor:l,lineGradient:d}=r;n&&this.mergeStyle(n),l&&this.drawBackgroundColor(t,e,i),c&&this.drawBackgroundImage(t,e,i),o&&this.drawImage(t,e,i),null!=a&&this.drawText(t,e,i,s),h&&this.drawBorder(t,e,i),d&&this.drawLineGradient(t,e,i)}o.forEach((s=>this.renderAnything(s,e,i,t))),n.restore()}renderAnything(t,e,n,h){s(t)||(r(t)?this.renderElementNode(t,e,n,h):a(t)?this.drawTextPrimitiv(t,e,n,h):i(t)?t.forEach((t=>this.renderAnything(t,e,n,h))):o(t)&&this.renderAnything(t.$node,e,n,h))}renderElementNode(t,e,i,s){if(t.props){const{position:s,size:n}=t.props,{x:o=0,y:r=0}=s||{},{width:a=0,height:h=0}=n||{},{align:c="left",verticalAlign:l="top"}=t.props;e+=o+a*{left:0,center:-.5,right:-1}[c];i+=r+h*{top:0,middle:-.5,bottom:-1}[l]}this.drawNode(t,e,i,s)}render(t){this.clearRect(),this.renderAnything(t,0,0,null)}}const c=(t,e)=>new Promise((function(i,s){const n=new Image;n.addEventListener("load",(()=>{e&&e(t,n),i(n)})),n.addEventListener("error",(()=>s(n))),n.src=t}));function l(t){return fetch(t).then((t=>t.json()))}function d(t){return fetch(t).then((t=>t.text())).then((t=>(t=>{const e=Object.create(null),i=t.split(/\r?\n/),s=i.shift().split(",");return i.forEach(((t,i)=>{if(!t.trim()||t.startsWith("//")||t.startsWith("#"))return;const n=t.split(","),[o]=n,r={sy:i};s.forEach(((t,e)=>{const i=n[e];i&&(["id","name","type"].includes(t)?r[t]=i:r[t]=isNaN(i)?i:Number(i))})),e[o]=r})),e})(t)))}const g=new Image;class f{constructor(){this.loaded=0,this.total=0,this.loading=!0,this.$resource=Object.create(null),this.$resource.maps=Object.create(null),this.$resource.shops=Object.create(null),this.$resource.image=Object.create(null),this.$resource.sprites=Object.create(null)}init(t){this.config=t,this.loadMapping(),this.loadImage(),this.loadSprite()}checkStatus(){this.loaded===this.total&&(this.loading=!1)}loadMapping(){this.config.resource.mapping.forEach((t=>{this.total++,d(`Data/${t}`).then((t=>{this.loaded++,this.$resource.mapping=t}))}))}loadImage(){this.config.resource.images.forEach((t=>{this.total++,c(`Image/${t}`).then((e=>{this.$resource.image[t]=e,this.loaded++,this.checkStatus()}))}))}loadMovie(){this.config.resource.images.forEach((t=>{this.total++,loadMovie(`Image/${t}`).then((e=>{this.$resource.image[t]=e,this.loaded++,this.checkStatus()}))}))}loadSprite(){this.config.resource.sprites.forEach((t=>{this.total++,c(`Sprite/${t}.png`).then((e=>{this.$resource.image[t]=e,this.loaded++,this.checkStatus()})),this.total++,d(`Sprite/${t}.dat`).then((e=>{this.$resource.sprites[t]=e,this.loaded++,this.checkStatus()}))}))}loadMap(t){return this.loaded=0,this.total=0,this.total++,l(`Maps/${t}.json`).then((e=>(this.$resource.maps[t]=e,this.loaded++,this.checkStatus(),e)))}loadShop(t){return this.loaded=0,this.total=0,this.total++,l(`Shops/${t}.json`).then((e=>(this.$resource.shops[t]=e,this.loaded++,this.checkStatus(),e)))}loadJSON(t){return this.loaded=0,this.total=0,this.total++,l(`Data/${t}.json`).then((e=>(this.$resource.maps[t]=e,this.loaded++,this.checkStatus(),e)))}loadConfig(){return l("config.json")}loadImageNext(t){if(this.$resource.image[t]=g,this.total++,t)return c(`Image/${t}`).then((e=>{this.$resource.image[t]=e,this.loaded++,this.checkStatus()})).catch((t=>{}))}}class p{constructor(t){this.config=t,this.sounds=Object.create(null),this.total=1/0}control(t,e,i){return null}play(t,e){return this.control(t,e,"play")}pause(t,e){return this.control(t,e,"pause")}}const u=["KeyDown","KeyUp"],$=["Click","TouchStart","TouchUp","TouchMove"],m=Object.create(null);[...$,...u].forEach((t=>{m[t.toLocaleLowerCase()]=`on${t}`}));class v{constructor(t){this.$render=t.$render,this.canvas=this.$render.canvas,this.$engine=t,this.currentFramesList=[],this.bindEvents();const e=this.canvas;this.canvas.$offsetWidth=e.offsetWidth,this.canvas.$offsetHeight=e.offsetHeight}callback=t=>{const e=this.canvas,{pixelRatio:i=32}=this.$engine.$config,{$offsetWidth:s,$offsetHeight:n,width:o,height:r}=e;t.canvasX=t.offsetX/s*o,t.canvasY=t.offsetY/n*r,t.gameX=Math.floor(t.canvasX/i),t.gameY=Math.floor(t.canvasY/i),t.name=m[t.type],this.colletEvent(t)};colletEvent(t){this.currentFramesList.push(t)}runEvent(t,e,i){if(!t)return;const{props:s,offsetParent:n}=t;i.props=s,s?.[e]?.(i,s),!i.cancelBubble&&this.runEvent(n,e,i)}runEvents(){this.currentFramesList.forEach((t=>{const{name:e,$node:i}=t;this.runEvent(i,e,t)})),this.currentFramesList=[]}bind(t,e){t.forEach((t=>{e.addEventListener(t.toLowerCase(),this.callback,{passive:!1})}))}bindEvents(){const t=this.canvas;this.bind($,t),this.bind(u,window)}unbindEvents(){this.canvas,$.forEach((t=>{document.addEventListener(t.toLowerCase(),this.callback,{passive:!1})}))}calcChildren(t,e,i,s){const{children:n}=t;n.forEach((s=>this.calcAnything(s,e,i,t)))}calcNode(t,e,i,s){const{props:n}=t;if(n){const{position:t,size:s}=n,{x:o=0,y:r=0}=t||{},{width:a=0,height:h=0}=s||{},{align:c,verticalAlign:l}=n;if(c){e+=o+a*{left:0,center:-.5,right:-1}[c]}else e+=o;if(l){i+=r+h*{top:0,middle:-.5,bottom:-1}[l]}else i+=r}t.offsetParent=s,this.calcEvent(t,e,i,s),this.calcChildren(t,e,i,s)}calcEvent(t,e,i){const{props:s}=t;if(s){const{size:n}=s,{width:o=0,height:r=0}=n||{};this.currentFramesList.forEach((s=>{if(s.code)return void(s.$node=t);const{gameX:n,gameY:a}=s;n>=e&&n<o+e&&a>=i&&a<r+i&&(s.$node=t)}))}}calcAnything(t,e,s,n){r(t)?this.calcNode(t,e,s,n):a(t)||(i(t)?t.forEach((t=>this.calcAnything(t,e,s,n))):o(t)&&this.calcAnything(t.$node,e,s,n))}calc(t){this.calcAnything(t,0,0,null),this.runEvents()}}class w{constructor(t){this.event={},this.mixin=t}on(t,e){this.event[t]=this.event[t]||[],this.event[t].push(e)}emit(t,e){this.event[t]=this.event[t]||[],this.event[t].forEach((t=>t.call(this,e,this.mixin)))}off(t,e){this.event[t]=this.event[t]||[];const i=this.event[t].indexOf(e);this.event[t].splice(i,1)}registry(...t){t.forEach((t=>{Object.entries(t).forEach((([t,e])=>{this.on(t,e)}))}))}}function b(t,e,...i){const s=this;return{createtor:t,props:e,children:i,get $parent(){return s}}}function x(t){a(t)||(o(t)?(x(t.$node),t.$instance.onDestroy?.()):i(t)?t.forEach((t=>{x(t)})):r(t)&&x(t.children))}function y(t){const e=t.$instance.render?.();t.$node=E(t.$node,e)}function E(t,e){if(a(e))x(t);else if(r(e))r(t)?E(t?.children,e.children):(x(t),E(null,e.children));else if(o(e))t&&t.createtor===e.createtor&&t.props?.key===e.props?.key?(s=t,(n=e).$instance=s.$instance,n.$node=s.$node,n.$instance.props=n.props,y(n)):(x(t),function(t){const e=Object.create(null),i=t.$parent;Object.entries(t.createtor).forEach((([t,i])=>{i.bind&&(e[t]=i.bind(e))})),e.$createElement=b,e.$config=i.$config,e.$state=i.$state,e.$loader=i.$loader,e.$resource=i.$loader.$resource,e.$event=i.$event,e.$sound=i.$sound,e.$render=i.$render,e.props=t.props,e.children=t.children,e.onCreate?.(),t.$instance=e,t.$node=null,y(t)}(e));else if(i(e))if(e.nodeMap=new Map,i(t))for(let i=0;i<e.length;i++){const s=e[i],n=s?.props?.key||i;e.nodeMap.set(n,s),E(t.nodeMap.get(n),s)}else{x(t);for(let t=0;t<e.length;t++){const i=e[t],s=i?.props?.key||t;e.nodeMap.set(s,i),E(null,e[t])}}var s,n;return e}class S{constructor(t){this.$app=t,this.checkRunTime()?(this.$loader=new f,this.$loader.loadConfig().catch((t=>alert("config.json不存在"+t))).then((t=>this.init(t)))):alert("不能直接运行index.html 或者 Chrome版本太老")}checkRunTime(){return!("file:"===location.protocol||!navigator.userAgentData)}init(t){document.title=t.title,this.$config=t,this.$state={save:Object.create(null)},this.$loader.init(t),this.$sound=new p(t,this.$loader),this.$render=new h(t,this.$loader),this.$eventStream=new v(this),this.$event=new w({$config:this.$config,$state:this.$state,$loader:this.$loader,$sound:this.$sound,$render:this.$render}),this.$root=null,this.gameStart()}gameStop(){cancelAnimationFrame(this.$requestAnimationId)}gameStart(){const t=()=>{this.$requestAnimationId=requestAnimationFrame((()=>{this.gameKeyFrame(),t()}))};t()}gameKeyFrame(){this.$eventStream.calc(this.$root),this.$root=E(this.$root,b.call(this,this.$app,null)),this.$render.render(this.$root)}}export{S as default};
