const t=["黑体","楷体","宋体","娃娃体-简","兰亭黑-简","凌慧体-简","翩翩体-简","魏碑体-简","雅痞体-简","苹方-简","楷体-简","黑体-简","宋体-简","Roboto","Noto Sans","Droid"].find((function(t,e=16){return document.fonts.check(`${e}px ${t}`)})),e={direction:"ltr",fillStyle:"#fff",font:"16px "+t,globalAlpha:1,globalCompositeOperation:"source-over",imageSmoothingEnabled:!1,lineCap:"butt",lineDashOffset:0,lineJoin:"miter",lineWidth:1,miterLimit:10,shadowBlur:0,shadowColor:"rgba(0, 0, 0, 0)",shadowOffsetX:0,shadowOffsetY:0,strokeStyle:"white",textAlign:"start",textBaseline:"top"},s=t=>{const e=typeof t;return"string"===e||"number"===e},i=t=>"function"==typeof t,n=t=>Array.isArray(t),o=t=>null==t,h=t=>"string"==typeof t,a=t=>"boolean"==typeof t,r=["ContextMenu","Click","Wheel","MouseDown","MouseUp","MouseMove"],l=["KeyDown","KeyUp"],c=32;class d{constructor(t){this.initCanvas(),this.bindEvents(),this.$data=t.$data,this.$images=t.$images}getImage=t=>this.$images.images[t];initCanvas(t={}){const s=document.createElement("canvas");this.canvas=s,this.context=s.getContext("2d");const{el:i,width:n=18*c,height:o=13*c}=t;this.screen=t,this.canvas.width=n,this.canvas.height=o;const h=document.querySelector(i)||document.body;h&&h.appendChild(this.canvas),this.mergeStyle(e),window.addEventListener("onresize",this.getCanvasRenderRect),this.getCanvasRenderRect()}getCanvasRenderRect(){const t=this.canvas;this.canvas.$offsetWidth=t.offsetWidth,this.canvas.$offsetHeight=t.offsetHeight}restoreEvents(){this.mouseEventsCollectionKeyframe=[],this.keyEventsCollectionKeyframe=[]}bindEvents(){this.restoreEvents();const t=this.canvas,{$offsetWidth:e,$offsetHeight:s,width:i,height:n}=t;r.forEach((t=>{this.canvas.addEventListener(t.toLowerCase(),(o=>{o.name=`on${t}`,o.canvasX=o.offsetX/e*i,o.canvasY=o.offsetY/s*n,this.mouseEventsCollectionKeyframe.push(o),o.preventDefault()}),{passive:!1})})),l.forEach((t=>{window.addEventListener(t.toLowerCase(),(e=>{e.name=`on${t}`,this.keyEventsCollectionKeyframe.push(e)}))}))}runEvents(){this.mouseEventsCollectionKeyframe.forEach((t=>{const{$node:e,name:s}=t;e&&e.props[s]&&e.props[s](t,e)})),this.keyEventsCollectionKeyframe.forEach((t=>{console.log(t);const{$instance:e,name:s}=t;e&&e[s]&&e[s](t)})),this.restoreEvents()}toDataURL(){return this.canvas.toDataURL()}mergeStyle=t=>{if(t){const{fontSize:e,fontFamily:s,font:i,textAlign:n,textBaseline:o,color:h,globalAlpha:a,fillStyle:r}=t;a&&(this.context.globalAlpha=a),n&&(this.context.textAlign=n),o&&(this.context.textBaseline=o),(h||r)&&(this.context.fillStyle=h||r),i&&(this.context.font=i),e&&(this.context.font=this.context.font.replace(/\d+px/,`${e}px`)),s&&(this.context.font=this.context.font.replace(/[\u4e00-\u9fa5]+/,s))}};clearRect(){const{context:t,canvas:e}=this;t.clearRect(0,0,e.width,e.height)}drawText(t,e,s){const{style:i,text:n}=t,{context:o}=this,{x:h=0,y:a=0}=i;o.fillText(n,e+h,s+a)}drawImage(t,e,s){const{props:i}=t;if(i){const{style:t={}}=i;if(t){const{sx:n=0,sy:o=0,width:h=c,height:a=c,swidth:r,sheight:l}=t,{context:d}=this;d.drawImage(this.getImage(i.src),n,o,r||h,l||a,e,s,h,a)}}}drawBack(t,e,s){const{context:i}=this,{backgroundImage:n,backgroundColor:o,height:h,width:a}=t.props.style;o&&(i.save(),i.beginPath(),i.rect(e,s,a,h),i.fillStyle=o,i.fill(),i.closePath(),i.restore()),n&&(i.save(),i.beginPath(),i.rect(e,s,a,h),i.fillStyle=i.createPattern(this.getImage(n),"repeat"),i.fill(),i.closePath(),i.restore())}drawBorder(t,e,s){const{context:i}=this,{borderWidth:n,borderColor:o,height:h,width:a}=t.props.style;n&&(i.save(),i.lineWidth=n,i.beginPath(),i.rect(e,s,a,h),o&&(i.strokeStyle=o),i.stroke(),i.closePath(),i.restore())}translate(t){const{context:e}=this,{style:s}=t,{x:i=0,y:n=0}=s;e.translate(i,n)}transform(t){const{context:e}=this,{rotate:s,scale:i}=t;if(s){const{angle:t=0,x:i=0,y:n=0}=s;e.translate(i,n),e.rotate(t*Math.PI/180),e.translate(-i,-n)}if(i){const{x:t=0,y:s=0,scaleX:n=1,scaleY:o=1}=i;e.translate(t,s),e.scale(n,o),e.translate(-t,-s)}}drawCircle(t,e,s){const{context:i}=this;i.save(),i.beginPath();const{cx:n,cy:o,r:h,sAngle:a,eAngle:r,counterclockwise:l=!1,stroke:c,strokeWidth:d}=t.props;i.arc(n+e,o+s,h,a/180*Math.PI,r/180*Math.PI,l),i.strokeStyle=c,i.lineWidth=d,i.stroke(),i.closePath(),i.restore()}drawLine(t){const{context:e}=this,{x1:s=0,y1:i=0,x2:n=200,y2:o=200}=t.props;e.beginPath(),e.moveTo(s,i),e.lineTo(n,o),e.stroke()}drawNode(t,e,s,i){const{context:n}=this;n.save();const{props:o,tag:h}=t;if(o){const{style:i}=o;this.mergeStyle(i),i&&(this.drawBack(t,e,s),this.drawBorder(t,e,s))}"img"===h?this.drawImage(t,e,s):"circle"===h?this.drawCircle(t,e,s):"line"===h?this.drawLine(t,e,e):"div"!==h&&"view"!==h&&console.error(`drawNode not support, check jsx <${h} ....`,t),this.renderAnything(t.children,e,s,t),n.restore()}drawPrimitive(t,e,s,i){var n;const{context:o}=this,{textAlign:h,textBaseline:a}=o,{width:r=0,height:l=0}=(null==i||null===(n=i.props)||void 0===n?void 0:n.style)||{};o.fillText(t,e+r*{start:0,left:0,center:.5,right:1,end:0}[h],s+l*{alphabetic:0,hanging:0,ideographic:0,top:0,middle:.5,bottom:1}[a])}renderAnything(t,e,r,c){o(t)||a(t)||(s(t)?this.drawPrimitive(t,e,r,c):n(t)?t.forEach((t=>this.renderAnything(t,e,r,c))):i(t.tag)?(this.keyEventsCollectionKeyframe.forEach((e=>{const s=t.instance;l.some((t=>s[`on${t}`]))&&(e.$instance=s)})),this.renderAnything(t.instance.$node,e,r,t.instance)):h(t.tag)?this.calcNode(t,e,r,c):this.drawPrimitive(JSON.stringify(t),e,r,c))}calcNode(t,e,s,i){var n;const{context:o}=this;o.save();const h=null==t||null===(n=t.props)||void 0===n?void 0:n.style;if(h){const{x:i=0,y:n=0}=h;e+=i,s+=n,this.mouseEventsCollectionKeyframe.forEach((i=>{const{canvasX:n,canvasY:o}=i;n>=e&&n<h.width+e&&o>=s&&o<h.height+s&&(i.$node=t)})),h&&h.overflow&&o.clip()}this.drawNode(t,e,s),o.restore()}render(t){this.clearRect(),this.renderAnything(t,0,0,this.canvas),this.runEvents()}}function p(t){const e=t.split(".");1===e.length&&e.unshift("");const[s,i]=e;return[s,i.split(";").map((t=>t.split(":")))]}function m(t){return fetch(t).then((t=>t.json()))}function y(t){return fetch(t).then((t=>t.text())).then((t=>(t=>{const e=[],s=(t=t.split(/\r?\n/)).shift().split(",");return t.forEach(((i,n)=>{if(!i.trim())return;const o=i.split(","),[h]=o,a={sy:n};return s.forEach(((t,e)=>{const s=o[e];s&&("property"===t?a[t]=p(s):["id","name","type"].includes(t)?a[t]=s:a[t]=isNaN(s)?s:Number(s))})),e[h]=a,e.push(a),t})),e})(t)))}class g{constructor(t){this.sounds=t||Object.create(null)}control(t,e,s){const i=this.sounds[`${t}/${e}`].cloneNode();return i.loop="bgm"===t,i[s](),i}load(t){return Promise.all(t.map((t=>{return e=`Sound/${t}`,new Promise((function(t,s){const i=new Audio;i.addEventListener("canplay",(()=>t(i))),i.addEventListener("error",(()=>s(i))),i.src=e}));var e}))).then((e=>{e.forEach(((e,s)=>this.sounds[t[s]]=e))}))}play(t,e){return this.control(t,e,"play")}pause(t,e){return this.control(t,e,"pause")}}class v{constructor(){this.images=Object.create(null)}load(t,e){return Promise.all([...e.map((t=>`Sprite/${t}.png`)),...t.map((t=>`Graph/${t}`))].map((t=>new Promise((e=>{(t=>new Promise((function(e,s){const i=new Image;i.addEventListener("load",(()=>e(i))),i.addEventListener("error",(()=>s(i))),i.src=t})))(`${t}`).then((s=>{t=t.replace("Graph/","").replace("Sprite/",""),this.images[t]=s,e()}))})))))}}const u=t=>t.endsWith(".dat")?y(`${t}`):m(`${t}`);class f{load(){return Promise.all(["game.json","save.json","shop.json","mapping.dat"].map((t=>u(`Data/${t}`)))).then((([t,e,s,i])=>{Object.assign(this,{game:t,save:e,shop:s,mapping:i});const n=t.sprites;Promise.all(n.map((t=>u(`Sprite/${t}.dat`)))).then((([t,e,s,i,n,o,h])=>{Object.assign(this,{enemys:t,items:e,animates:s,icons:i,npcs:n,terrains:o,boss:h})}))}))}}class x{constructor(){this.$font=Object.create(null)}load(t){return function({name:t,url:e}){const s=new FontFace(t,`url("${e}")`);return document.fonts.add(s),s.load(),s.loaded}(t)}}function $(t,e,...s){return{tag:t,props:e,children:s,$parent:this}}function w(t){if(!s(t)&&!o(t))if(i(t.tag))w(t.instance.$node),t.instance.destroy&&t.instance.destroy();else if(n(t))for(;t.length;)w(t.pop());else w(t.children)}function k(t){t.instance.$node=C(t.instance.$node,t.instance.render())}function C(t,e){if(o(e)||s(e)||a(e))w(t);else if(n(e))if(n(t))for(let s=0;s<e.length;s++)C(t[s],e[s]);else{w(t);for(let t=0;t<e.length;t++)C(null,e[t])}else if(i(e.tag)){var r,l;t&&t.tag===e.tag&&(null===(r=t.props)||void 0===r?void 0:r.key)===(null===(l=e.props)||void 0===l?void 0:l.key)?function(t,e){e.instance=t.instance,e.instance.props=e.props,k(e)}(t,e):(w(t),function(t){const e=t.tag;t.instance=new e(t),t.instance.$images=t.$parent.$images,t.instance.$sound=t.$parent.$sound,t.instance.$data=t.$parent.$data,t.instance.$font=t.$parent.$font,t.instance.create&&t.instance.create(),k(t)}(e))}else if(h(e.tag)){C(t&&t.children,e.children)}return e}class b{constructor({props:t,children:e}){this.props=t,this.$node=null,this.$children=e}$c(){return $.apply(this,arguments)}}class E extends b{interval=-1;tick=0;render(){const{x:t=0,y:e=0,width:s,height:i,src:n,maxTick:o,maxInterval:h=10,center:a,sy:r=0}=this.props.data;return this.interval++,this.interval===h&&(this.interval=0,this.tick++,this.tick===o&&(this.tick=0)),this.$c("img",{src:n,style:{x:t+(a?-s/2:0),y:e+(a?-i/2:0),sx:this.tick*s,sy:i*r,width:s,height:i}})}}class S extends b{styles={select:{fontSize:24,textAlign:"center",width:320}};create(){this.activeIndex=this.props.activeIndex||0;const{style:t}=this.props;t&&Object.assign(this.styles.select,t)}onKeyDown({code:t}){"ArrowDown"===t?(this.activeIndex++,this.activeIndex===this.props.options.length&&(this.activeIndex=0),this.props.onChange&&this.props.onChange(this.activeIndex,this.props.options[this.activeIndex])):"ArrowUp"===t?(this.activeIndex--,-1===this.activeIndex&&(this.activeIndex+=this.props.options.length),this.props.onChange&&this.props.onChange(this.activeIndex,this.props.options[this.activeIndex])):"Space"===t&&this.props.onConfirm&&this.props.onConfirm(this.activeIndex,this.props.options[this.activeIndex])}onMouseDown=t=>{this.activeIndex=t,this.props.onConfirm&&this.props.onConfirm(this.activeIndex,this.props.options[this.activeIndex])};setActiveIndex(t){this.activeIndex=t}render(){return this.$c("div",{style:this.styles.select},this.props.options.map((({text:t},e)=>this.$c("div",{style:{y:32*e,height:32,width:this.styles.select.width,borderWidth:this.activeIndex===e?2:0,borderColor:"#ddd"},onMouseDown:this.onMouseDown.bind(this,e),onMouseMove:this.setActiveIndex.bind(this,e)},t))))}}class M extends b{render(){const{dataSource:t,columns:e,size:s=32,data:i}=this.props;let n=0;return e.map(((e,o)=>{const{title:h,dataIndex:a,width:r=1,render:l}=e,c=this.$c("div",{style:{x:0,y:0,textAlign:"start"}},this.$c("div",{style:{x:n,width:r*s,height:s}},h),t.map(((t,e)=>this.$c("div",{style:{x:n,y:(e+1)*s,width:r*s,height:s}},l?l.call(this,t,i,e,o):t[a]))));return n+=r*s,c}))}}class I{constructor(t){this.checkChromeVersion()&&(this.$state=Object.create(null),this.$data=new f,this.$sound=new g,this.$images=new v,this.$font=new x,this.$ui=new d(this),this.$root=null,this.$game=t,this.gameStart())}checkChromeVersion(){if("file:"!==location.protocol)return!0;alert("不能直接运行index.html")}gameStop(){cancelAnimationFrame(this.ident),this.ident=-1}gameStart(){const t=()=>{this.keyFrame(),this.ident=requestAnimationFrame(t)};t()}keyFrame(){this.$root=C(this.$root,$.call(this,this.$game,null)),this.$ui.render(this.$root)}}class D extends b{styles={fps:{fontSize:14,textAlign:"right",textBaseline:"top",height:32,x:576}};static getTime=()=>performance.now();timeStamp=D.getTime();render(){const t=D.getTime(),e=1e3/(t-this.timeStamp);return this.timeStamp=t,this.$c("div",{style:this.styles.fps},`${e.toFixed()}fps`)}}class A extends b{tick=0;render(){return this.tick+=.01,this.tick>.95&&(this.tick=.95),this.$c("div",{style:{x:64,y:64}},this.$c("div",{style:{width:448,height:32,backgroundColor:"white"}}),this.$c("div",{style:{width:448*this.tick,height:32,backgroundColor:"#666"}}))}}function L(t){return e="game",s=t,localStorage.setItem(e,JSON.stringify(s));var e,s}function K(){return function(t){try{return JSON.parse(localStorage.getItem(t))}catch(t){return null}}("game")}const T={title:{width:576,height:416},gameName:{y:64,width:576,height:128,fontSize:128},select:{x:256,y:256,width:64}};class O extends b{create(){this.activeIndex=K()?1:0,this.options=[{text:"开始"},{text:"继续"}]}onConfirm=t=>{this.props.onLoadMap(t?K():null)};render(){return this.$c("div",{style:T.title},this.$c("div",{style:T.gameName},this.$data.game.title),this.$c(E,{data:{src:"stand.png",maxTick:4,sy:4,x:208,y:100,width:158,height:96}}),this.$c(E,{data:{src:"skill.png",maxTick:6,sy:4,width:152,height:100,x:308,y:200}}),this.$c(E,{data:{src:"run.png",maxTick:6,width:166,height:103,sy:4,x:108,y:200}}),this.$c(S,{activeIndex:this.activeIndex,options:this.options,style:T.select,onConfirm:this.onConfirm}))}}class B extends b{create(){this.shop=JSON.parse(JSON.stringify(this.$data.shop[this.props.shopid])),this.shop.choices.push({text:"离开"})}onConfirm=t=>{if(t===this.shop.choices.length-1)this.props.onClose();else{const{need:e,effect:s}=this.shop.choices[t];this.props.onShopEvent(e,s)}};render(){return this.$c("img",{src:"shop.webp",style:{x:96,y:64,width:224,height:256,borderWidth:4,borderColor:"#deb887",swidth:500,sheight:701}},this.$c("div",{style:{y:24,width:224,fontSize:24}},this.shop.title),this.$c("div",{style:{x:0,y:48,fontSize:14}},this.shop.text.split(/\n/).map(((t,e)=>this.$c("div",{style:{x:112,y:32*e/2}},t)))),this.$c(S,{options:this.shop.choices,onConfirm:this.onConfirm,style:{x:32,y:112,width:160,fontSize:16},onClose:this.props.onClose}))}}class j extends b{tick=0;styles={battle:{x:32,y:32,width:512,height:352,fontSize:20,borderWidth:3,borderColor:"#deb887",swidth:640,sheight:320},enemy:{x:32,y:32},hero:{x:320,y:32}};create(){this.enemy=JSON.parse(JSON.stringify(this.props.enemy)),this.hero=this.props.hero}onKeyDown({code:t}){"Space"===t&&this.battleMsg&&this.props.onClose&&this.props.onClose()}onClick(){this.battleMsg&&this.props.onClose&&this.props.onClose()}render(){const t=this.enemy,e=this.hero;location.hostname;if(t.hp>0&&(this.tick++,3===this.tick)){if(this.turn){const s=t.atk-e.def;s>0&&(e.hp-=s)}else{const s=e.atk-t.def;if(s>0&&(t.hp-=s),t.hp<=0){t.hp=0;const{exp:s,money:i}=t;e.exp+=s,this.$data.save.money+=i,this.battleMsg=`战斗胜利，获得${i}金币，${s}经验`}}this.turn=!this.turn,this.tick=0}const s=[{text:"名称",key:"name"},{text:"生命",key:"hp"},{text:"攻击",key:"atk"},{text:"防御",key:"def"}],i={x:32,y:144,swidth:32,sheight:32,width:64,height:64,sy:0},n={x:32,y:144,swidth:32,sheight:32,width:64,height:64,sy:32*t.sy},o={x:208,y:64,height:64,width:64},h={fontSize:24,height:32,y:256,width:480};return this.$c("img",{src:"Battlebacks/mota.jpg",style:this.styles.battle,onClick:this.onClick},this.battleMsg&&this.$c("div",{style:h},this.battleMsg),this.$c("div",{style:this.styles.enemy},this.$c("img",{src:"enemys.png",style:n}),s.map(((e,s)=>this.$c("div",{style:{x:0,y:32*s}},this.$c("div",{style:{width:128,textAlign:"left",height:32}},e.text),this.$c("div",{style:{width:128,textAlign:"right",height:32}},t[e.key]))))),this.$c("div",{style:o},"VS"),this.$c("div",{style:this.styles.hero},this.$c("img",{src:"Characters/hero.png",style:i}),s.map(((t,s)=>this.$c("div",{style:{x:0,y:32*s}},this.$c("div",{style:{width:128,textAlign:"left",height:32}},e[t.key]),this.$c("div",{style:{width:128,textAlign:"right",height:32}},t.text))))))}}class P extends b{index=0;width=7;styles={talk:{width:32*this.width,height:32,backgroundColor:"black",borderWidth:2,borderColor:"white",fontSize:16,textAlign:"left",textBaseline:"middle"}};onKeyDown({code:t}){"Space"===t&&(this.index++,this.index===this.props.talk.length?this.props.onConfirm():this.next(),this.$sound.play("se","dialogue.mp3"))}next(){const t=this.props.talk[this.index].split(/\n/);this.current=[],t.forEach((t=>{for(let e=0;e<t.length;e+=14)this.current.push(t.substr(e,14))}));const e={x:64,y:64,height:32*this.current.length},s={x:128,y:192,height:32*this.current.length};this.turn=!this.turn,Object.assign(this.styles.talk,this.turn?e:s)}create(){this.next()}render(){return this.$c("div",{style:this.styles.talk},this.current.map(((t,e)=>this.$c("div",{style:{x:0,y:32*e,width:32*this.width,height:32}},t))))}}const N={wrap:{textAlign:"left",fontSize:18,backgroundImage:"ground.png",width:512,x:32,y:32,height:352}},z=[{title:null,width:1,render(t){return this.$c(E,{data:{src:"enemys.png",maxTick:2,width:32,height:32,maxInterval:10,sy:t.sy}})}},{title:"名字",dataIndex:"name",width:3},{title:"生命",dataIndex:"hp",width:2},{title:"攻击",dataIndex:"atk",width:2},{title:"防御",dataIndex:"def",width:2},{title:"损失",dataIndex:"address",width:2,render(t,e){if(e.atk>t.def){if(e.def>=t.atk)return 0;{const s=Math.floor(t.hp/(e.atk-t.def)),i=(t.atk-e.def)*s;return e.hp>i?i:this.$c("div",{style:{color:"red",height:32}},i)}}return"-"}}];class R extends b{onKeyDown(){this.props.onClose()}onMouseDown=()=>{this.props.onClose()};render(){const t=Object.keys(this.props.enemys).map((t=>this.$data.enemys[t]));return this.$c("div",{style:N.wrap,onMouseDown:this.onMouseDown},this.$c(M,{dataSource:t,columns:z,data:this.$data.save.hero}))}}class W extends b{create(){const t=this.$data.save.shops||[];this.options=Object.entries(t).map((([t,e])=>({text:e,shopid:t})))}onConfirm=t=>{if(t>-1){const{shopid:e}=this.options[t];this.props.onConfirm(e)}};onKeyDown({code:t}){"KeyB"===t&&this.props.onClose()}render(){return this.$c("img",{src:"shop.webp",style:{x:96,y:64,width:224,height:256,borderWidth:4,borderColor:"#deb887",swidth:500,sheight:701}},this.$c("div",{style:{y:24,width:224,fontSize:24}},"商店选择"),this.$c(S,{style:{x:32,y:48,width:160,fontSize:16},options:this.options,onConfirm:this.onConfirm,onClose:this.props.onClose}))}}function F(t,e){return!(t.x>=e.x+e.width||t.x+t.width<=e.x||t.y>=e.y+e.height||t.y+t.height<=e.y)}function J(t,e){return Object.assign(t,e)}const U={lv:"等级",money:"金币",hp:"生命",atk:"攻击",def:"防御",exp:"经验"};class X extends b{tick=0;create(){const t=Object.assign(this.$data.save.position,{width:32,height:32});this.styles={hero:t}}isCoincidedTerrains(t){return this.props.mapTerrains.findIndex((e=>e&&e&&F(e.props.style,t)))}isCoincidedEvents(t){return this.props.mapEvents.findIndex((e=>e&&e&&F(e.props.style,t)))}onKeyDown({code:t}){const e=this.styles.hero;let s=null;if("ArrowDown"===t?(s={y:32},e.sy=0):"ArrowUp"===t?(s={y:-32},e.sy=3):"ArrowLeft"===t?(s={x:-32},e.sy=1):"ArrowRight"===t?(s={x:32},e.sy=2):"KeyS"===t?(L(this.$data.save),this.$sound.play("se","load.mp3"),this.setMessage("存储成功")):"KeyL"===t?(this.$sound.play("se","load.mp3"),this.props.onLoadMap(K()),this.setMessage("读取成功")):"KeyX"===t?this.showEnemyInfo=!this.showEnemyInfo:"KeyB"===t?this.buying=!0:"Backspace"===t&&(this.updateSaveData("hero",{lv:1,hp:100,atk:100,def:100,exp:100}),this.updateSaveData("items",{yellowKey:3,blueKey:2,redKey:1}),this.updateSaveData("",{money:100})),s){const t=function(t,e){return t=Object.assign(Object.create(null),t),Object.entries(e).forEach((([e,s])=>{t[e]+=s})),t}(e,s);if(-1!==this.isCoincidedTerrains(t))return;const i=this.isCoincidedEvents(t);if(-1!==i)return void(this.handleEvents(this.props.map.mapEvents[i])&&J(e,t));J(e,t)}}onShopClose=()=>{this.shopid=null,this.setEvent()};handleEvents(t){if(!this.mapEvent)if(t[3])this.mapEvent=t,this.eventIndex=0,this.setEvent();else{const e=this.$data.mapping[t[2]],{name:s,type:i}=e;if("items"===i){const e=this.$data.items[s],{type:i}=e;if("1"===i||"3"===i)this.remove(t),this.updateSaveData("items",s),this.setMessage(`获得${e.name}`),this.$sound.play("se","1"===i?"item.mp3":"constants.mp3");else if("2"===i){this.remove(t),this.updateSaveData(...e.property);const[s,i]=e.property;let n=`获得${e.name}`;i.forEach((t=>{const[e,i]=t;let o=e;"hero"===s?o=U[e]:"items"===s?o=this.$data.items[e].name:"money"===e&&(o="金币"),n+=` ${o}${i>0?"+":"-"}${i}`,this.setMessage(n)})),this.$sound.play("se","item.mp3")}return!0}if("enemys"===i)return t[3]=[{type:"enemy",data:s}],this.handleEvents(t),!1;if("terrains"===i&&["yellowDoor","redDoor","blueDoor","steelDoor","specialDoor"].includes(s)){const e=s.slice(0,-4)+"Key";if(this.$data.save.items[e])return this.$data.save.items[e]--,this.remove(t),this.$sound.play("se","door.mp3"),!0}}}setEvent=()=>{if(this.eventIndex<this.mapEvent[3].length){const t=this.mapEvent[3][this.eventIndex++],{type:e,data:s}=t;if("talk"===e)return void(this.talk=s);if("mapLoad"===e)this.props.onLoadMap(s);else{if("openShop"===e)return this.shopid=t.id,this.$data.save.shops=this.$data.save.shops||{},void(this.$data.save.shops[this.shopid]=this.$data.shop[this.shopid].title);if("getItems"===e)this.updateSaveData("items",s);else{if("removeSelf"===e)return void this.remove(this.mapEvent);if("moveBlock"===e)return void this.remove(this.mapEvent);if("enemy"===e){const t=this.$data.enemys[s],e=this.$data.save.hero;return e.atk>t.def?e.def>=t.atk||t.hp/(e.atk-t.def)<=e.hp/(t.atk-e.def)?void(this.enemy=t):(this.mapEvent=null,this.eventIndex=0,void this.setMessage(`你打不过${t.name}`)):(this.mapEvent=null,this.eventIndex=0,void this.setMessage(`你的攻击比${t.name}的防御低`))}if("updateSaveData"===e)this.updateSaveData(...p(s));else if("removeBlock"===e)this.props.removeMapEvent(s);else if("title"===e)this.props.onTitle();else if("removeMapBlock"===e){const{mapId:t,position:e}=s,{x:i,y:n}=e;this.$data.save.destroy[[t,i,n]]=!0}else if("if"===e){const{condition:e,true:s,false:i}=t;this.mapEvent=null,this.eventIndex=0,this.checkSaveData(...p(e))?this.mapEvent=[0,0,0,s]:this.mapEvent=[0,0,0,i]}}}this.setEvent()}else this.mapEvent=null};remove(t){this.props.removeMapEvent(t),this.mapEvent=null}onBattleClose=()=>{this.enemy=null,this.props.removeMapEvent(this.mapEvent),this.setEvent()};onConfirm=()=>{this.talk=null,this.setEvent()};setMessage=t=>{this.props.onMessage(t)};updateSaveData(t,e,s=1){if(Array.isArray(e))e.forEach((([e,s])=>this.updateSaveData(t,e,s)));else if("string"==typeof e){const i=t?this.$data.save[t]:this.$data.save;i[e]=i[e]||0,i[e]+=Number(s)}else"object"==typeof e&&this.updateSaveData(t,Object.entries(e))}checkSaveData(t,e,s=1){if(Array.isArray(e))return e.some((([e,s])=>this.checkSaveData(t,e,s)));if("string"==typeof e){const i=t?this.$data.save[t]:this.$data.save;return i[e]=i[e]||0,i[e]+Number(s)>=0}return"object"==typeof e&&this.checkSaveData(t,Object.entries(e),null,0)}onShopEvent=(t,e)=>{this.checkSaveData(...p(t))&&(this.updateSaveData(...p(t)),this.updateSaveData(...p(e)))};onShopListClose=()=>{this.buying=!1};onShopListConfirm=t=>{this.buying=!1,this.shopid=t,this.mapEvent=[0,0,0,[]]};render(){return this.$c("div",null,this.$c("div",{style:this.styles.hero,src:"Characters/hero.png"},this.$c(E,{data:{src:"Characters/hero.png",maxTick:4,width:32,height:32,maxInterval:10,sy:this.styles.hero.sy}})),this.buying&&this.$c(W,{onClose:this.onShopListClose,onConfirm:this.onShopListConfirm}),this.shopid&&this.$c(B,{shopid:this.shopid,onClose:this.onShopClose,onShopEvent:this.onShopEvent}),this.enemy&&this.$c(j,{enemy:this.enemy,enemyId:this.enemyId,hero:this.$data.save.hero,onClose:this.onBattleClose}),this.talk&&this.$c(P,{talk:this.talk,key:this.talk,onConfirm:this.onConfirm}),this.showEnemyInfo&&this.$c(R,{enemys:this.props.enemys,onClose:()=>this.showEnemyInfo=!1}))}}class Y extends b{create(){this.walls=[];for(let t=0;t<5;t++)for(let e=0;e<13;e++)4!==t&&0!==e&&12!==e||this.walls.push(this.$c("img",{src:"terrains.png",style:{sx:0,sy:64,x:32*t,y:32*e}}))}render(){const{map:t}=this.props,{save:e}=this.$data,s=[this.$data.game.title,t.name,e.hero.lv,e.hero.hp,e.hero.atk,e.hero.def,e.hero.exp,e.money,e.items.yellowKey,e.items.blueKey,e.items.redKey];return this.$c("div",{style:{fontSize:24}},this.walls,s.map(((t,e)=>this.$c("div",{style:{y:32*(e+1),width:32,height:32}},this.$c("img",{src:"icons.png",style:{sy:32*e,width:32,height:32,swidth:32,sheight:32}}),this.$c("div",{style:{x:32,height:32,width:96}},t)))))}}class H extends b{tick=0;interval=10;styles={map:{height:416,width:416,backgroundImage:"ground.png"},statusBar:{x:416,y:0,backgroundImage:"ground.png",width:160,height:416}};create(){const t=this.props.map.bgm;this.mapBgm=this.$sound.play("bgm",t)}destroy(){this.props.map.bgm,this.mapBgm.pause()}renderMapTerrains(t){const{mapTerrains:e}=this.props.map,s=this.tick,i=[];if(!e)return;let n=0;return e.forEach(((t,e)=>{t.forEach(((t,o)=>{if(t){const h=this.$data.mapping[t],{type:a,name:r}=h,l=this.$data[a][r];if("animates"===a){n=s%4*32;const t={sy:32*l.sy,sx:n,x:32*o,y:32*e,height:32,width:32};i.push(this.$c("img",{src:a+".png",style:t}))}else if("terrains"===a){const t={sy:32*l.sy,sx:0,x:32*o,y:32*e,height:32,width:32};i.push(this.$c("img",{src:a+".png",style:t}))}else console.error("error type",a,h)}}))})),i}renderMapEvents(){const{mapId:t,destroy:e={}}=this.$data.save,{mapEvents:s}=this.props.map,i=this.tick,n={};if(this.enemys=n,s)return s.map((s=>{const[o,h,a,r]=s;if(e[[t,o,h]])return null;if(a){const t=this.$data.mapping[a];if(t){const{type:e,name:s}=t,a=this.$data[e][s];let r=0;return"npcs"!==e&&"enemys"!==e||(r=i%2*32),"enemys"===e&&(n[s]=s),this.$c("div",{style:{x:32*o,y:32*h,height:32,width:32}},this.$c("img",{src:e+".png",style:{sy:32*a.sy,sx:r,height:32,width:32}}))}}return null}))}onRemoveMapEvent=t=>{const[e,s]=t,i=this.$data.save.mapId;this.$data.save.destroy=this.$data.save.destroy||{},this.$data.save.destroy[[i,e,s]]=1};onTitle=()=>{this.props.onTitle()};onMouseDown=t=>{console.warn(t)};render(){this.interval--,0===this.interval&&(this.tick++,this.interval=10);const t=this.renderMapTerrains(),e=this.renderMapEvents();return this.$c("div",null,this.$c("div",{style:this.styles.map,onMouseDown:this.onMouseDown},t,e),this.$c("div",{style:this.styles.statusBar},this.$c(Y,{map:this.props.map})),this.$c(X,{mapTerrains:t,mapEvents:e,enemys:this.enemys,map:this.props.map,onLoadMap:this.props.onLoadMap,onMessage:this.props.onMessage,removeMapEvent:this.onRemoveMapEvent,onTitle:this.onTitle}))}}class V extends b{styles={text:{fontSize:20,textAlign:"left",textBaseline:"top",x:0,y:0,width:576,height:416},scroll:{x:32,y:160}};create(){const{text:t,bgm:e}=this.props.map;this.text=t.split("\n"),this.mapBgm=this.$sound.play("bgm",e)}destroy(){this.mapBgm.pause()}onKeyDown({code:t}){"Space"===t&&this.onMouseDown()}onMouseDown=()=>{if(this.ready){const{type:t,data:e}=this.props.map.event;"mapLoad"===t?this.props.onClose(e):"title"===t&&this.props.onTitle(e)}};render(){const t=this.styles.scroll;if(t.y>-32*(this.text.length-2)){const e=1;t.y-=e}else this.ready=!0;return this.$c("div",{style:this.styles.text,onMouseDown:this.onMouseDown},this.$c("div",{style:this.styles.scroll},this.text.map(((t,e)=>this.$c("div",{style:{y:32*e}},t)))))}}class q extends b{create(){this.props&&(this.tick=this.props.tick||90),this.length=function(t){let e=0;for(let s=0;s<t.length;s++)t.charCodeAt(s)>127?e+=2:e+=1;return e}(this.props.msg),this.msg=this.props.msg}render(){if(this.tick--,0===this.tick)return this.props.onMessageClose(),null;let t=1;this.tick<15&&(t=this.tick/15);const e=10*this.length+20;return this.$c("div",{style:{backgroundColor:"rgba(0,0,0,.7)",globalAlpha:t,x:(576-e)/2,y:64,height:32,width:e}},this.$c("div",{style:{textAlign:"center",fontSize:20,x:e/2,height:32}},this.msg))}}class G extends b{styles={app:{height:416,width:576,textAlign:"center",textBaseline:"middle"}};async create(){this.loading="加载数据",await this.$data.load();const t=this.$data.game;if(document.title=t.title,t.font&&!1!==t.font.load){this.loading="加载字体";const e=t.font;await this.$font.load(e)}t.images&&(this.loading="加载图片",await this.$images.load(t.images,t.sprites)),t.sounds&&(this.loading="加载音乐",await this.$sound.load(t.sounds)),this.loading=!1}onLoadMap=async t=>{var e;this.loading="加载地图",Object.assign(this.$data.save,t),this.map=await(e=this.$data.save.mapId,m(`Maps/${e}.json`)),this.loading=!1,this.randMapKey=`${this.$data.save.mapId} ${new Date}`};onTitle=()=>{this.map=null};onMessageClose=()=>{this.msg=null};onMessage=t=>{this.msg=t};render(){return this.$c("div",{style:this.styles.app},this.loading?this.$c(A,{msg:this.loading}):this.map?this.map.text?this.$c(V,{map:this.map,onClose:this.onLoadMap,onTitle:this.onTitle}):this.$c(H,{map:this.map,key:this.randMapKey,onLoadMap:this.onLoadMap,onMessage:this.onMessage,onEvent:this.onEvent}):this.$c(O,{onLoadMap:this.onLoadMap}),this.msg&&this.$c(q,{msg:this.msg,key:this.msg,onMessageClose:this.onMessageClose}),this.$c(D,null))}}"undefined"!=typeof window&&(window.mota=new I(G));
//# sourceMappingURL=bundle.js.map
